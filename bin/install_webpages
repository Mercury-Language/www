#!/bin/sh
#
# install_webpages
#
# Responsible for updating the hypermail archive, updating the
# search database and installing the web pages.
#
# Note this script must be run on a machine with php3, hypermail and htdig
# installed, ie ceres, have the INSTALL_WEBDIR environment variable set
# and be run from the top level directory of the w3 module.
#

# www_host=venus
www_host=ceres

PATH=/usr/local/bin:$PATH
export PATH

CVSROOT=/home/mercury1/repository
export CVSROOT

echo Install started at `date`

whathost=`hostname | sed -e 's/\..*//'`
if [ $whathost != "$www_host" ]
then
    echo "** install_webpages: must be run on $www_host."
    exit 1
fi

DIR=${INSTALL_WEBDIR=spec_unknown_value}
if [ $DIR == "spec_unknown_value" ]
then
    echo "** install_webpages: INSTALL_WEBDIR not set."
    exit 1
fi

if [ ! -e "news.php3" ]
then
    echo "** install_webpages: must be run from the top level of w3 module."
    exit 1
fi

set -x

    #
    # Rearchive the mailing list.
    #
(
    cd mailing-lists;
    ./rearchive || {
    	echo "*** rearchive failed" 1>&2
    }
)

    #
    # Install the web pages
    #
cvs update -d . || echo "*** cvs update failed" 1>&2
cvs checkout tutorial || echo "*** cvs checkout failed" 1>&2
# Some html pages depend on the latest rotd version, so we need to force
# them to be regenerated by doing a make clean.
make clean || echo "*** make clean failed" 1>&2
make install || echo "*** make install failed" 1>&2
make delete_old_rotds || echo "*** make delete_old_rotds failed" 1>&2

    #
    # Reindex the web site for searching.
    #
echo Reindex of website started at `date`
umask 002

    # Index the web-site for searching.
htdig -c /etc/htdig/htdig-mercury.conf -a -i || {
	echo "*** htdig failed" 1>&2
	exit 1
}
htmerge -c /etc/htdig/htdig-mercury.conf -a || {
	echo "*** htmerge failed" 1>&2
	exit 1
}

    # Replace the work files with their alternate versions.
cd /var/lib/htdig || {
	echo "*** can't cd to /var/lib/htdig" 1>&2
	exit 1
}
for file in `ls *.work`
do
    mv $file `basename $file .work` || {
	echo "*** mv failed" 1>&2
	exit 1
    }
done

echo Install finished at `date`
